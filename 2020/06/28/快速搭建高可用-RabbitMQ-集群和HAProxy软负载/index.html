<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="RabbitMQ 高可用集群架构 将两个 RabbitMQ 磁盘节点和一个 RabbitMQ 内存节点组成一个内建集群，之所以要用两个磁盘节点是防止，唯一的磁盘节点挂掉后，不能重建队列，交换器。用 HAProxy 作为 RabbitMQ 集群的负载均衡。为了防止 HAProxy 单点故障，用 Keepalived 将两个 HAProxy 节点做成一主一备。应用使用 VIP（虚拟IP） 访问 HAP">
<meta name="keywords" content="java">
<meta property="og:type" content="article">
<meta property="og:title" content="快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载">
<meta property="og:url" content="https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/index.html">
<meta property="og:site_name" content="刘海川的技术博客">
<meta property="og:description" content="RabbitMQ 高可用集群架构 将两个 RabbitMQ 磁盘节点和一个 RabbitMQ 内存节点组成一个内建集群，之所以要用两个磁盘节点是防止，唯一的磁盘节点挂掉后，不能重建队列，交换器。用 HAProxy 作为 RabbitMQ 集群的负载均衡。为了防止 HAProxy 单点故障，用 Keepalived 将两个 HAProxy 节点做成一主一备。应用使用 VIP（虚拟IP） 访问 HAP">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://i.loli.net/2020/06/28/NsegBhwiOmu4zCj.png">
<meta property="og:image" content="https://i.loli.net/2020/06/29/LfcTdKPnWbrkweH.jpg">
<meta property="og:image" content="https://i.loli.net/2020/06/29/W43GiaIpUrSBync.jpg">
<meta property="og:updated_time" content="2020-06-29T01:07:43.830Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载">
<meta name="twitter:description" content="RabbitMQ 高可用集群架构 将两个 RabbitMQ 磁盘节点和一个 RabbitMQ 内存节点组成一个内建集群，之所以要用两个磁盘节点是防止，唯一的磁盘节点挂掉后，不能重建队列，交换器。用 HAProxy 作为 RabbitMQ 集群的负载均衡。为了防止 HAProxy 单点故障，用 Keepalived 将两个 HAProxy 节点做成一主一备。应用使用 VIP（虚拟IP） 访问 HAP">
<meta name="twitter:image" content="https://i.loli.net/2020/06/28/NsegBhwiOmu4zCj.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="https://github.com/al-liu">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/al-liu?tab=repositories">项目</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2019/10/14/vue-cli3-webpack-打包优化实践总结/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&text=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&title=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&is_video=false&description=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载&body=Check out this article: https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&title=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&title=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&title=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&title=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&name=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ-高可用集群架构"><span class="toc-number">1.</span> <span class="toc-text">RabbitMQ 高可用集群架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作"><span class="toc-number">2.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ-集群"><span class="toc-number">3.</span> <span class="toc-text">RabbitMQ 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务分布情况"><span class="toc-number">3.1.</span> <span class="toc-text">服务分布情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建第一个-RabbitMQ-节点"><span class="toc-number">3.2.</span> <span class="toc-text">创建第一个 RabbitMQ 节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署第二个-RabbitMQ-节点"><span class="toc-number">3.3.</span> <span class="toc-text">部署第二个 RabbitMQ 节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署第三个-RabbitMQ-节点"><span class="toc-number">3.4.</span> <span class="toc-text">部署第三个 RabbitMQ 节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HAProxy-负载均衡"><span class="toc-number">4.</span> <span class="toc-text">HAProxy 负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务分布情况-1"><span class="toc-number">4.1.</span> <span class="toc-text">服务分布情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-Keepalived-给-HAProxy-做主备"><span class="toc-number">5.</span> <span class="toc-text">使用 Keepalived 给 HAProxy 做主备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备工作-1"><span class="toc-number">5.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装-Keepalived"><span class="toc-number">5.2.</span> <span class="toc-text">安装 Keepalived</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-Keepalived-配置文件"><span class="toc-number">5.3.</span> <span class="toc-text">创建 Keepalived 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试-Keepalived"><span class="toc-number">5.4.</span> <span class="toc-text">测试 Keepalived</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">刘海川的技术博客</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-06-28T13:15:29.000Z" itemprop="datePublished">2020-06-28</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/java/">java</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="RabbitMQ-高可用集群架构"><a href="#RabbitMQ-高可用集群架构" class="headerlink" title="RabbitMQ 高可用集群架构"></a>RabbitMQ 高可用集群架构</h2><p><img src="https://i.loli.net/2020/06/28/NsegBhwiOmu4zCj.png" alt="RabbitMQ 集群架构.png"></p>
<p>将两个 RabbitMQ 磁盘节点和一个 RabbitMQ 内存节点组成一个内建集群，之所以要用两个磁盘节点是防止，唯一的磁盘节点挂掉后，不能重建队列，交换器。用 HAProxy 作为 RabbitMQ 集群的负载均衡。为了防止 HAProxy 单点故障，用 Keepalived 将两个 HAProxy 节点做成一主一备。应用使用 VIP（虚拟IP） 访问 HAProxy 服务时，默认连接主机（Master）的 HAProxy，当主机（Master）上的 HAProxy 故障时，VIP 会漂移到备机（Backup）上，就会连接备机（Backup）上的 HAProxy 服务。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>服务器安装 docker，docker-compose，准备离线镜像 rabbitmq.tar，haproxy.tar。<br>服务器节点间可以相互 ping 通。</p>
<h2 id="RabbitMQ-集群"><a href="#RabbitMQ-集群" class="headerlink" title="RabbitMQ 集群"></a>RabbitMQ 集群</h2><p>使用 RabbitMQ 内建集群，持久化队列无法在队列节点崩溃时，自动连接别的节点创建队列，非持久化队列可以自动连接可用节点创建队列。我们的项目使用的非持久化队列。</p>
<p>至少保证有两个磁盘节点，否则在唯一磁盘节点崩溃时，无法在集群中创建队列，交换器等元数据。</p>
<h3 id="服务分布情况"><a href="#服务分布情况" class="headerlink" title="服务分布情况"></a>服务分布情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.213 服务器部署 RabbitMQ Disc Node1。</span><br><span class="line">192.168.1.203 服务器部署 RabbitMQ Disc Node2。</span><br><span class="line">192.168.1.212 服务器部署 RabbitMQ RAM Node3。</span><br></pre></td></tr></table></figure>
<h3 id="创建第一个-RabbitMQ-节点"><a href="#创建第一个-RabbitMQ-节点" class="headerlink" title="创建第一个 RabbitMQ 节点"></a>创建第一个 RabbitMQ 节点</h3><p>登录服务器，创建目录 /app/mcst/rabbitmq。</p>
<p>将镜像 tar 包 rabbitmq.tar，服务编排文件 mcst-rabbitmq-node1.yaml 通过 sftp 上传到刚创建的目录下。</p>
<p>导入镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker load -i rabbitmq.tar</span><br><span class="line">$ docker images # 查看是否导入成功</span><br></pre></td></tr></table></figure>
<p>查看服务编排文件 mcst-rabbitmq-node1.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3&apos;</span><br><span class="line">services:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    container_name: mcst-rabbitmq</span><br><span class="line">    image: rabbitmq:3-management</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 4369:4369</span><br><span class="line">      - 5671:5671</span><br><span class="line">      - 5672:5672</span><br><span class="line">      - 15672:15672</span><br><span class="line">      - 25672:25672</span><br><span class="line">    environment:</span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">      - RABBITMQ_ERLANG_COOKIE=iweru238roseire</span><br><span class="line">      - RABBITMQ_DEFAULT_USER=mcst_admin</span><br><span class="line">      - RABBITMQ_DEFAULT_PASS=mcst_admin_123</span><br><span class="line">      - RABBITMQ_DEFAULT_VHOST=mcst_vhost</span><br><span class="line">    hostname: rabbitmq1</span><br><span class="line">    extra_hosts:</span><br><span class="line">      - rabbitmq1:192.168.1.213</span><br><span class="line">      - rabbitmq2:192.168.1.203</span><br><span class="line">      - rabbitmq3:192.168.1.212</span><br><span class="line">    volumes:</span><br><span class="line">      - ./data:/var/lib/rabbitmq</span><br></pre></td></tr></table></figure>
<p>部署命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose -f mcst-rabbitmq-node1.yaml up -d</span><br></pre></td></tr></table></figure>
<p>注意：三个节点 RABBITMQ_ERLANG_COOKIE 保持一致。一定要有 extra_hosts 配置，否则在搭建集群的过程中会连接不到其他 rabbitmq 节点服务。此节点作为集群根节点。</p>
<h3 id="部署第二个-RabbitMQ-节点"><a href="#部署第二个-RabbitMQ-节点" class="headerlink" title="部署第二个 RabbitMQ 节点"></a>部署第二个 RabbitMQ 节点</h3><p>方法同上，上传 rabbitmq.sh 脚本到 volumes 配置的 ./rabbitmq.sh 路径。查看 mcst-rabbitmq-node2.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3&apos;</span><br><span class="line">services:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    container_name: mcst-rabbitmq</span><br><span class="line">    image: rabbitmq:3-management</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 4369:4369</span><br><span class="line">      - 5671:5671</span><br><span class="line">      - 5672:5672</span><br><span class="line">      - 15672:15672</span><br><span class="line">      - 25672:25672</span><br><span class="line">    environment:</span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">      - RABBITMQ_ERLANG_COOKIE=iweru238roseire</span><br><span class="line">      - RABBITMQ_DEFAULT_USER=mcst_admin</span><br><span class="line">      - RABBITMQ_DEFAULT_PASS=mcst_admin_123</span><br><span class="line">      - RABBITMQ_DEFAULT_VHOST=mcst_vhost</span><br><span class="line">    hostname: rabbitmq2</span><br><span class="line">    extra_hosts:</span><br><span class="line">      - rabbitmq1:192.168.1.213</span><br><span class="line">      - rabbitmq2:192.168.1.203</span><br><span class="line">      - rabbitmq3:192.168.1.212</span><br><span class="line">    volumes:</span><br><span class="line">      - ./rabbitmq.sh:/home/rabbitmq.sh</span><br><span class="line">      - ./data:/var/lib/rabbitmq</span><br></pre></td></tr></table></figure>
<p>部署命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose -f mcst-rabbitmq-node2.yaml up -d</span><br></pre></td></tr></table></figure>
<p>节点启动完成后，通过命令进入 rabbitmq2 节点的容器中，执行 /home/rabbitmq.sh 脚本。如果报权限错误，则在容器内执行 <code>chmod +x /home/rabbitmq.sh</code> 赋权，然后 <code>bash /home/rabbitmq.sh</code> 执行脚本添加到集群中。</p>
<p>进入容器的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it mcst-rabbitmq /bin/bash</span><br></pre></td></tr></table></figure>
<p>脚本内容如下（磁盘节点）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl join_cluster rabbit@rabbitmq1</span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></table></figure>
<h3 id="部署第三个-RabbitMQ-节点"><a href="#部署第三个-RabbitMQ-节点" class="headerlink" title="部署第三个 RabbitMQ 节点"></a>部署第三个 RabbitMQ 节点</h3><p>方法同上，查看 mcst-rabbitmq-node3.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3&apos;</span><br><span class="line">services:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    container_name: mcst-rabbitmq</span><br><span class="line">    image: rabbitmq:3-management</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 4369:4369</span><br><span class="line">      - 5671:5671</span><br><span class="line">      - 5672:5672</span><br><span class="line">      - 15672:15672</span><br><span class="line">      - 25672:25672</span><br><span class="line">    environment:</span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">      - RABBITMQ_ERLANG_COOKIE=iweru238roseire</span><br><span class="line">      - RABBITMQ_DEFAULT_USER=mcst_admin</span><br><span class="line">      - RABBITMQ_DEFAULT_PASS=mcst_admin_123</span><br><span class="line">      - RABBITMQ_DEFAULT_VHOST=mcst_vhost</span><br><span class="line">    hostname: rabbitmq3</span><br><span class="line">    extra_hosts:</span><br><span class="line">      - rabbitmq1:192.168.1.213</span><br><span class="line">      - rabbitmq2:192.168.1.203</span><br><span class="line">      - rabbitmq3:192.168.1.212</span><br><span class="line">    volumes:</span><br><span class="line">      - ./rabbitmq-ram.sh:/home/rabbitmq-ram.sh</span><br><span class="line">      - ./data:/var/lib/rabbitmq</span><br></pre></td></tr></table></figure>
<p>部署命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose -f mcst-rabbitmq-node3.yaml up -d</span><br></pre></td></tr></table></figure>
<p>在启动 rabbitmq3 节点，启动后，进入容器内部，执行 <code>bash /home/rabbitmq-ram.sh</code> 脚本添加内存节点到集群中。</p>
<p>脚本内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl join_cluster --ram rabbit@rabbitmq1</span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></table></figure>
<p>在容器内部使用命令查看集群状态：<code>rabbitmqctl cluster_status</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Cluster status of node rabbit@rabbitmq1 ...</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit@rabbitmq1,rabbit@rabbitmq2]&#125;,&#123;ram,[rabbit@rabbitmq3]&#125;]&#125;,</span><br><span class="line"> &#123;running_nodes,[rabbit@rabbitmq2,rabbit@rabbitmq3,rabbit@rabbitmq1]&#125;,</span><br><span class="line"> &#123;cluster_name,&lt;&lt;&quot;rabbit@rabbitmq2&quot;&gt;&gt;&#125;,</span><br><span class="line"> &#123;partitions,[&#123;rabbit@rabbitmq3,[rabbit@rabbitmq1]&#125;,</span><br><span class="line">              &#123;rabbit@rabbitmq1,[rabbit@rabbitmq3]&#125;]&#125;,</span><br><span class="line"> &#123;alarms,[&#123;rabbit@rabbitmq2,[]&#125;,&#123;rabbit@rabbitmq3,[]&#125;,&#123;rabbit@rabbitmq1,[]&#125;]&#125;]</span><br></pre></td></tr></table></figure>
<p>也可以通过 <a href="http://192.168.1.213:15672" target="_blank" rel="noopener">http://192.168.1.213:15672</a> 进入管理端查看集群状态。</p>
<p><img src="https://i.loli.net/2020/06/29/LfcTdKPnWbrkweH.jpg" alt="rabbitmq集群.jpg"></p>
<h2 id="HAProxy-负载均衡"><a href="#HAProxy-负载均衡" class="headerlink" title="HAProxy 负载均衡"></a>HAProxy 负载均衡</h2><p>创建目录 /app/mcst/haproxy，将镜像 tar 包，haproxy 配置文件，docker 服务编排文件上传到该目录。</p>
<p>导入镜像方法同上。</p>
<p>查看服务编排文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3&apos;</span><br><span class="line">services:</span><br><span class="line">  haproxy:</span><br><span class="line">    container_name: mcst-haproxy</span><br><span class="line">    image: haproxy:2.1</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 8100:8100</span><br><span class="line">      - 15670:5670</span><br><span class="line">    environment:</span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">    extra_hosts:</span><br><span class="line">      - rabbitmq1:192.168.1.213</span><br><span class="line">      - rabbitmq2:192.168.1.203</span><br><span class="line">      - rabbitmq3:192.168.1.212</span><br><span class="line">    volumes:</span><br><span class="line">      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro</span><br></pre></td></tr></table></figure>
<p>重点是设置 extra_hosts（rabbitmq 集群节点 ip） 和 volumes（使用自定义的配置文件）。</p>
<p>haproxy 配置文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log 127.0.0.1 local0 info</span><br><span class="line">    maxconn 4096</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    log     global</span><br><span class="line">    mode    tcp</span><br><span class="line">    option  tcplog</span><br><span class="line">    retries 3</span><br><span class="line">    option  redispatch</span><br><span class="line">    maxconn 2000</span><br><span class="line">    timeout connect 5s</span><br><span class="line">    timeout client 120s</span><br><span class="line">    timeout server 120s</span><br><span class="line"></span><br><span class="line"># ssl for rabbitmq</span><br><span class="line"># frontend ssl_rabbitmq</span><br><span class="line">    # bind *:5673 ssl crt /root/rmqha_proxy/rmqha.pem</span><br><span class="line">    # mode tcp</span><br><span class="line">    # default_backend rabbitmq</span><br><span class="line"></span><br><span class="line"># web 管理界面</span><br><span class="line">listen stats</span><br><span class="line">    bind *:8100</span><br><span class="line">    mode http</span><br><span class="line">    stats enable</span><br><span class="line">    stats realm Haproxy\ Statistics</span><br><span class="line">    stats uri /</span><br><span class="line">    stats auth admin:admin123</span><br><span class="line"># 配置负载均衡</span><br><span class="line">listen rabbitmq</span><br><span class="line">    bind *:5670</span><br><span class="line">    mode tcp</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server  rabbitmq1 rabbitmq1:5672  check inter 5s rise 2 fall 3</span><br><span class="line">    server  rabbitmq2 rabbitmq2:5672  check inter 5s rise 2 fall 3</span><br><span class="line">    server  rabbitmq3 rabbitmq3:5672  check inter 5s rise 2 fall 3</span><br></pre></td></tr></table></figure>
<p>部署命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose -f mcst-haproxy.yaml up -d</span><br></pre></td></tr></table></figure>
<h3 id="服务分布情况-1"><a href="#服务分布情况-1" class="headerlink" title="服务分布情况"></a>服务分布情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.212 服务器部署 HAProxy Master。</span><br><span class="line">192.168.1.203 服务器部署 HAProxy Backup。</span><br></pre></td></tr></table></figure>
<p>分别在以上两个节点起好 HAProxy 服务。</p>
<p>登录 HAProxy 的管理端查看集群状态：<a href="http://192.168.1.212:8100/。" target="_blank" rel="noopener">http://192.168.1.212:8100/。</a></p>
<p><img src="https://i.loli.net/2020/06/29/W43GiaIpUrSBync.jpg" alt="haproxy.jpg"></p>
<h2 id="使用-Keepalived-给-HAProxy-做主备"><a href="#使用-Keepalived-给-HAProxy-做主备" class="headerlink" title="使用 Keepalived 给 HAProxy 做主备"></a>使用 Keepalived 给 HAProxy 做主备</h2><h3 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h3><p>申请一个和服务节点同一局域网的 ip 地址，该 ip 不能被占用，作为 VIP（虚拟ip）。</p>
<h3 id="安装-Keepalived"><a href="#安装-Keepalived" class="headerlink" title="安装 Keepalived"></a>安装 Keepalived</h3><p>到 Keepalived 官网下载最新版本包，本次安装使用的是 2.0.20 版本。<br>下载好后的文件是：keepalived-2.0.20.tar.gz。</p>
<p>上传到服务器，对 tar 包解压缩。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar -xf keepalived-2.0.20.tar.gz</span><br></pre></td></tr></table></figure>
<p>检查依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd keepalived-2.0.20</span><br><span class="line">$ ./configure</span><br></pre></td></tr></table></figure>
<p>Keepalived 的安装需要以下依赖 gcc，openssl-devel。</p>
<p>安装命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y gcc</span><br><span class="line">$ yum install -y openssl-devel</span><br></pre></td></tr></table></figure>
<p>因为是内网服务器不能使用外网的 yum 源，所以需要更改用本地 yum 源。</p>
<p><a href="https://www.jianshu.com/p/9fca8b68939b" target="_blank" rel="noopener">搭建本地 yum 源的参考文章</a></p>
<p>将 linux 的安装光盘镜像上传到 /mnt/iso 目录下，并 mount 到 /mnt/cdrom 目录下，作为 yum 的一个安装源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /mnt/iso</span><br><span class="line">$ mkdir /mnt/cdrom </span><br><span class="line">$ mv /ftp/rhel-server-7.3-x86_64-dvd.iso /mnt/iso</span><br></pre></td></tr></table></figure>
<p>挂载光盘镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mount -ro loop /mnt/iso/rhel-server-7.3-x86_64-dvd.iso /mnt/cdrom </span><br><span class="line">$ mv /ftp/myself.repo /etc/yum.repos.d</span><br><span class="line">$ yum clean all </span><br><span class="line">$ yum makecache </span><br><span class="line">$ yum update</span><br></pre></td></tr></table></figure>
<p>附：myself.repo文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[base]</span><br><span class="line">name= Red Hat  Enterprise Linux $releasever  -  $basearch  -  Source</span><br><span class="line">baseurl=file:///mnt/cdrom</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///mnt/cdrom/RPM-GPG-KEY-redhat-release</span><br></pre></td></tr></table></figure>
<p>更改完成后，以后每次需要 linux 安装盘安装软件包时，只需要执行 mount 命令，将光盘 ISO 文件加载即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mount -ro loop /mnt/iso/rhel-server-7.3-x86_64-dvd.iso /mnt/cdrom</span><br></pre></td></tr></table></figure>
<p>这时使用 yum 安装 gcc，openssl-devel就没问题了。</p>
<p>如果使用本地 yum 源的条件也不具备，那么可以使用 yum 的 downloadonly 插件。</p>
<p>要在能连接外网和<strong>系统版本一致</strong>的机器上将需要的依赖下载下来，到目标内网机器上本地安装。</p>
<p><a href="https://www.yanning.wang/archives/664.html" target="_blank" rel="noopener">downloadonly 使用方法的参考文章</a></p>
<p><strong>还是推荐使用本地 yum 源的方式。</strong></p>
<p>安装完 gcc，openssl-devel 后，再次执行 ./configure 会报一个警告。</p>
<p>“this build will not support IPVS with IPv6. Please install libnl/libnl-3 dev libraries to support IPv6 with IPVS.”</p>
<p>安装如下依赖解决</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y libnl libnl-devel</span><br></pre></td></tr></table></figure>
<p>安装完成后再次 ./configure 就没问题了。</p>
<p>然后执行 make 编译</p>
<p>最后执行 make install 安装</p>
<p>安装完成后执行 keepalived –version，输出版本号即为安装成功。</p>
<h3 id="创建-Keepalived-配置文件"><a href="#创建-Keepalived-配置文件" class="headerlink" title="创建 Keepalived 配置文件"></a>创建 Keepalived 配置文件</h3><p>创建配置文件 /etc/keepalived/keepalived.conf</p>
<p>Master 节点配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;  # verify haproxy&apos;s pid existance</span><br><span class="line">    interval 5                   # check every 2 seconds</span><br><span class="line">    weight -2                    # if check failed, priority will minus 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    # 主机: MASTER</span><br><span class="line">    # 备机: BACKUP</span><br><span class="line">    state MASTER</span><br><span class="line">    # 实例绑定的网卡, 用ip a命令查看网卡编号</span><br><span class="line">    interface ens192</span><br><span class="line">    # 虚拟路由标识，这个标识是一个数字(1-255)，在一个VRRP实例中主备服务器ID必须一样</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    # 优先级，数字越大优先级越高，在一个实例中主服务器优先级要高于备服务器</span><br><span class="line">    priority 101</span><br><span class="line">    # 虚拟IP地址,可以有多个，每行一个</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.110</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;               # Scripts state we monitor</span><br><span class="line">        chk_haproxy              </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ens192 是网卡名，ifconfig 命令查看服务器网卡，找到和本机服务 ip 对应的网卡，virtual_router_id 的值要和 backup 节点上的配置保持一致。<code>killall -0 haproxy</code> 命令的意思是，如果 haproxy 服务存在执行该命令，什么都不会发生，如果服务不存在，执行该命令会报找不到进程 <code>haproxy: no process found</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 网卡信息</span><br><span class="line">ens192: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.1.203  netmask 255.255.255.0  broadcast 192.168.1.255</span><br><span class="line">        inet6 fe80::250:56ff:fe94:bceb  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:50:56:94:bc:eb  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 88711011  bytes 12324982140 (11.4 GiB)</span><br><span class="line">        RX errors 0  dropped 272  overruns 0  frame 0</span><br><span class="line">        TX packets 88438149  bytes 10760989492 (10.0 GiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line"># haproxy 服务不存在</span><br><span class="line">[root@localhost ~]# killall -0 haproxy</span><br><span class="line">haproxy: no process found</span><br></pre></td></tr></table></figure>
<p>master 节点的 priority 在减去 weight 后要比 backup 节点的 priority 低才行，否则主备切换不成功。</p>
<p>Backup节点配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;  # verify haproxy&apos;s pid existance</span><br><span class="line">    interval 5                   # check every 2 seconds</span><br><span class="line">    weight -2                    # if check failed, priority will minus 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    # 主机: MASTER</span><br><span class="line">    # 备机: BACKUP</span><br><span class="line">    state BACKUP</span><br><span class="line">    # 实例绑定的网卡, 用ip a命令查看网卡编号</span><br><span class="line">    interface ens192</span><br><span class="line">    # 虚拟路由标识，这个标识是一个数字(1-255)，在一个VRRP实例中主备服务器ID必须一样</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    # 优先级，数字越大优先级越高，在一个实例中主服务器优先级要高于备服务器</span><br><span class="line">    priority 100</span><br><span class="line">    # 虚拟IP地址,可以有多个，每行一个</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.110</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;               # Scripts state we monitor</span><br><span class="line">        chk_haproxy              </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建完配置，启动 keepalived。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart keepalived</span><br></pre></td></tr></table></figure>
<h3 id="测试-Keepalived"><a href="#测试-Keepalived" class="headerlink" title="测试 Keepalived"></a>测试 Keepalived</h3><p>在 Master，Backup 节点上，使用 <code>ip addr</code> 命令看下 vip 在哪台机器的 ens192 网卡上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000</span><br><span class="line">    link/ether 00:50:56:94:c1:79 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.1.212/24 brd 192.168.1.255 scope global ens192</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.1.110/32 scope global ens192</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::250:56ff:fe94:c179/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>默认在 master 主机上，停掉 master 主机的 haproxy 服务，然后在用 <code>ip addr</code> 查看虚拟 ip 在哪个机器上，如果漂移到备份主机上则代表热备生效。</p>
<p>在开启 master 主机的 haproxy 服务，<code>ip addr</code> 查看虚拟ip应该重新漂移回 master 主机上。</p>
<p>测试服务，使用虚拟 ip 加服务端口号访问 HAProxy 服务。</p>
<p>至此，高可用的 rabbitmq 集群 和 haproxy 软负载就搭建完成。</p>

  </div>
</article>



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
    <div id="gitalk-container"></div>
    <script type="text/javascript">
        var gitalk = new Gitalk({
            clientID: '46f9862d762f2b91e265',
            clientSecret: 'b1a5c3d47828b1c1ab0b25081463e2b94f132245',
            id: md5(window.location.pathname),
            repo: 'al-liu.github.io',
            owner: 'al-liu',
            admin: 'al-liu',
            distractionFreeMode: ''
        })
        gitalk.render('gitalk-container')
    </script>




        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="https://github.com/al-liu">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/al-liu?tab=repositories">项目</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ-高可用集群架构"><span class="toc-number">1.</span> <span class="toc-text">RabbitMQ 高可用集群架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作"><span class="toc-number">2.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ-集群"><span class="toc-number">3.</span> <span class="toc-text">RabbitMQ 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务分布情况"><span class="toc-number">3.1.</span> <span class="toc-text">服务分布情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建第一个-RabbitMQ-节点"><span class="toc-number">3.2.</span> <span class="toc-text">创建第一个 RabbitMQ 节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署第二个-RabbitMQ-节点"><span class="toc-number">3.3.</span> <span class="toc-text">部署第二个 RabbitMQ 节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署第三个-RabbitMQ-节点"><span class="toc-number">3.4.</span> <span class="toc-text">部署第三个 RabbitMQ 节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HAProxy-负载均衡"><span class="toc-number">4.</span> <span class="toc-text">HAProxy 负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务分布情况-1"><span class="toc-number">4.1.</span> <span class="toc-text">服务分布情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-Keepalived-给-HAProxy-做主备"><span class="toc-number">5.</span> <span class="toc-text">使用 Keepalived 给 HAProxy 做主备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备工作-1"><span class="toc-number">5.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装-Keepalived"><span class="toc-number">5.2.</span> <span class="toc-text">安装 Keepalived</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-Keepalived-配置文件"><span class="toc-number">5.3.</span> <span class="toc-text">创建 Keepalived 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试-Keepalived"><span class="toc-number">5.4.</span> <span class="toc-text">测试 Keepalived</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&text=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&title=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&is_video=false&description=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载&body=Check out this article: https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&title=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&title=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&title=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&title=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://github.com/al-liu/2020/06/28/快速搭建高可用-RabbitMQ-集群和HAProxy软负载/&name=快速搭建高可用 RabbitMQ 集群和 HAProxy 软负载&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 刘海川 al-liu
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="https://github.com/al-liu">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/al-liu?tab=repositories">项目</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
